//
// Created by hujiayucc on 25-5-9.
//

#include <appinfo.h>
#include <constant.h>

ApplicationInfo::ApplicationInfo() {
    // 初始化数组
    _addres.resize(_cnt, 0);
    _args = {
        "author", // 0: 作者信息
        "appv", // 1: 版本信息
        "describe", // 2: 描述信息
        "getticketaddres", // 3: _addres[0] 滑块处理
        "getvefcodeaddres", // 4: _addres[1] 验证码处理
        "useproaddres", // 5: _addres[2] 启用处理
        "banproaddres", // 6: _addres[3] 禁用处理
        "unitproaddres", // 7: _addres[4] 卸载处理
        "setproaddres", // 8: _addres[5] 设置处理
        "friendmsaddres", // 9: _addres[6] 私聊处理
        "groupmsaddres", // 10: _addres[7] 群消息处理
        "ChannelFunc", // 11: _addres[8] 频道处理
        "eventmsaddres", // 12: _addres[9] 事件处理
        "PmDealFunc" // 13: _addres[10] 输出过滤
    };
    _infos.resize(_cnt_info);
    Api_names = {
        "Emoji转QQ空间EmId", "Emoji转频道EmojiId", "QQ列表_二维码登录_拉取二维码", "QQ列表_二维码登录_查询二维码状态", "QQ列表_删除QQ", "QQ列表_添加QQ",
        "QQ列表_添加手表协议QQ", "QQ点赞", "QQ空间EmId转Emoji", "QQ空间EmId转小黄豆Id", "上传QQ封面", "上传合并转发消息", "上传头像", "上传好友图片",
        "上传好友文件s", "上传好友语音", "上传小视频", "上传涂鸦", "上传照片墙图片", "上传群临时文件s", "上传群图片", "上传群头像", "上传群文件", "上传群文件s",
        "上传群聊语音红包匹配语音", "上传群语音", "上传频道图片", "上传频道文件", "上报当前位置",
        "上报当前位置s", "下线其他设备", "下线指定QQ", "二维码扫一扫授权其他设备资料辅助验证登录", "二维码扫一扫授权登录其他应用", "付款",
        "余额提现", "保存文件到微云", "修改个性签名", "修改好友分组名", "修改好友备注", "修改子频道名称", "修改我的频道用户信息_年龄", "修改我的频道用户信息_性别", "修改我的频道用户信息_所在地",
        "修改我的频道用户信息_昵称", "修改指定QQ缓存密码", "修改支付密码", "修改昵称", "修改群名称",
        "修改群相册信息", "修改讨论组名称", "修改资料", "修改身份组信息", "修改频道排序", "修改频道简介", "全员禁言", "关闭设备锁", "分享音乐", "分享音乐_频道", "创建子频道",
        "创建日程", "创建群文件夹", "创建群相册", "创建群聊",
        "删除好友", "删除好友分组", "删除子频道", "删除子频道_批量", "删除日程", "删除群成员", "删除群成员_批量", "删除群成员_批量s", "删除群文件", "删除群文件夹",
        "删除群相册", "删除群相册照片", "删除讨论组成员", "删除说说", "删除身份组", "刷新频道列表缓存", "发布说说", "发送QQ咨询会话", "发送功能包", "发送好友json消息",
        "发送好友xml消息", "发送好友消息", "发送数据包", "发送群json消息", "发送群xml消息", "发送群临时消息", "发送群公告", "发送群消息", "发送订阅号私聊消息",
        "发送讨论组json消息",
        "发送讨论组xml消息", "发送讨论组临时消息", "发送讨论组消息", "发送输入状态", "发送通行证到好友", "发送通行证到群", "发送频道消息", "发送频道私信消息", "发送验证消息会话消息",
        "取QQ会员中心cookie",
        "取QQ头像K值", "取QQ空间cookie", "取QQ钱包个人信息", "取h5钱包cookie", "取sessionkey", "取个性签名", "取加群链接", "取历史登录设备guid列表",
        "取合并转发消息内容", "取图片下载地址",
        "取在线移动设备列表", "取好友Diy名片数据", "取好友分组列表", "取好友列表", "取好友在线状态", "取好友文件下载地址", "取好友能量值与QID", "取子频道分组列表", "取子频道分组结构",
        "取子频道列表",
        "取子频道名称_从缓存", "取子频道管理列表", "取扩列资料", "取收款链接", "取日程信息", "取昵称_从缓存", "取最新动态列表", "取框架QQ", "取框架插件列表", "取消精华",
        "取特定身份组成员列表", "取私信频道Id", "取私信频道列表_从缓存", "取私聊小视频下载地址", "取管理层列表", "取群Id_从缓存", "取群列表", "取群名片", "取群名称_从缓存",
        "取群小视频下载地址",
        "取群应用列表", "取群成员信息", "取群成员列表", "取群成员概况", "取群成员简略信息", "取群文件下载地址", "取群文件内存利用状态", "取群文件列表", "取群文件总数", "取群未领红包",
        "取群相册列表", "取群相册照片列表", "取群网页cookie", "取群艾特全体剩余次数", "取订阅号列表", "取讨论组列表", "取讨论组名称_从缓存", "取讨论组成员列表", "取讨论组文件下载地址",
        "取讨论组未领红包",
        "取话题子频道帖子列表", "取资料展示设置", "取钱包cookie", "取频道信息", "取频道列表_从缓存", "取频道加入验证方式", "取频道号", "取频道名称_从缓存", "取频道头像", "取频道封面",
        "取频道成员身份组", "取频道文件下载地址", "取频道昵称_从缓存", "取频道用户个性档案", "取频道用户昵称_从缓存", "取频道用户资料", "取频道红包pre_grap_token", "取频道身份组列表",
        "回复QQ咨询会话", "回复验证消息会话消息",
        "处理好友验证事件", "处理群验证事件", "处理群验证事件_风险号", "处理频道加入申请", "头像双击_好友", "头像双击_群", "好友口令红包", "好友接龙红包", "好友文件转发至好友",
        "好友普通红包",
        "好友生僻字红包", "好友画图红包", "好友语音红包", "子频道慢速模式设置", "子频道消息提醒设置", "子频道消息通知设置", "小黄豆Id转QQ空间EmId", "屏蔽频道用户私信", "强制取昵称",
        "强制取自身匿名Id",
        "恢复设备锁", "打好友电话", "拉起代付", "拉起群收款", "拍一拍好友在线状态", "提交支付验证码", "提取图片文字", "搜索表情包", "搜索频道", "撤回消息_私聊本身",
        "撤回消息_群聊", "撤回消息_群聊s", "撤回消息_讨论组", "撤回频道消息", "撤回频道私信消息", "支付代付请求", "支付群收款", "文字转语音", "新增好友分组", "新增身份组",
        "是否已开启QQ咨询", "是否被禁言", "更改私聊消息内容", "更改群聊消息内容", "更改频道名称", "更改频道消息内容", "构造卡片消息文本代码", "查看转发聊天记录内容", "查询代付状态",
        "查询好友信息",
        "查询网址安全性", "查询群信息", "查询群收款状态", "查询群设置", "框架重启", "消息合并转发至好友", "消息合并转发至群", "消息合并转发至讨论组", "添加好友", "添加好友_取验证类型",
        "添加群", "添加群_取验证类型", "申请加入频道", "登录指定QQ", "登录指定QQ_二次登录", "登录网页取ck", "禁言群匿名", "禁言群成员", "禁言频道成员", "私聊置顶",
        "移动好友分组", "移动群文件", "移除频道成员", "移除频道成员_批量", "红包转发", "经纬度定位查询详细地址", "结束群收款", "置好友验证方式", "置子频道发言权限", "置子频道观看权限",
        "置屏蔽好友", "置特别关心好友", "置群内消息通知", "置群消息接收", "置群聊备注", "群收款_催单", "群文件转发至好友", "群文件转发至群", "群权限_一起写", "群权限_上传文件",
        "群权限_上传相册", "群权限_匿名聊天", "群权限_发起临时会话", "群权限_发起新的群聊", "群权限_坦白说", "群权限_新成员查看历史消息", "群权限_群幸运字符", "群权限_设置加群方式",
        "群权限_设置群发言频率", "群权限_设置群昵称规则",
        "群权限_设置群查找方式", "群权限_邀请好友加群", "群权限_邀请方式设置", "群聊专属红包", "群聊口令红包", "群聊打卡", "群聊拼手气红包", "群聊接龙红包", "群聊普通红包", "群聊生僻字红包",
        "群聊画图红包", "群聊签到", "群聊置顶", "群聊语音红包", "群验证消息接收设置", "翻译", "获取bkn_gtk", "获取clientkey", "获取pskey", "获取skey",
        "获取子频道分享链接", "获取当前登录设备信息", "获取日程列表", "获取日程链接", "获取红包领取详情", "获取红包领取详情s", "获取订单详情", "获取频道分享链接", "获取频道成员列表", "解散群",
        "讨论组专属红包", "讨论组口令红包", "讨论组拼手气红包", "讨论组接龙红包", "讨论组文件转发至好友", "讨论组文件转发至群", "讨论组普通红包", "讨论组生僻字红包", "讨论组画图红包",
        "讨论组语音红包",
        "设为精华", "设置Diy名片", "设置专属头衔", "设置位置共享", "设置位置共享s", "设置在线状态", "设置子频道分组结构", "设置子频道管理", "设置子频道精华消息", "设置我的频道昵称",
        "设置指定身份组子频道发言权限", "设置指定身份组子频道观看权限", "设置是否允许别人私信我", "设置直播子频道主播", "设置管理员", "设置群名片", "设置资料展示", "设置频道全员禁言",
        "设置频道全局公告_指定消息", "设置频道加入验证方式",
        "设置频道成员身份组", "语音红包匹配", "语音转文字", "说说点赞", "说说评论", "请求ssoseq", "账号搜索", "转让群", "转账", "输出日志",
        "退出讨论组", "退出频道", "退群", "邀请好友加入讨论组_批量", "邀请好友加群", "邀请好友加群_批量", "重命名群文件夹", "领取私聊普通红包", "领取红包", "领取群聊专属红包",
        "领取讨论组专属红包", "领取频道专属红包", "频道EmojiId转Emoji", "频道专属红包", "频道拼手气红包", "频道普通红包", "频道消息粘贴表情", "频道用户私信免打扰"
    };
}

void ApplicationInfo::ProcessAppName(std::string &appName) {
    const std::string forbiddenChars = "/\\:*?\"<>|'\r\n";
    for (char c: forbiddenChars) {
        appName.erase(std::remove(appName.begin(), appName.end(), c), appName.end());
    }
}

std::string ApplicationInfo::EscapeString(const std::string &input) {
    std::string output;
    for (const char c: input) {
        switch (c) {
            case '\\': output += "\\\\";
                break;
            case '\"': output += "\\\"";
                break;
            case '\r': output += "\\r";
                break;
            case '\n': output += "\\n";
                break;
            default: output += c;
                break;
        }
    }
    return output;
}

void ApplicationInfo::SetAppName(const std::string &appName) {
    std::string processed = appName;
    ProcessAppName(processed);
    _currentAppName = processed;
}

void ApplicationInfo::AddPermissionRequest(const int permission, const std::string &reason) {
    if (permission < 1 || permission > _cnt_Apis) return;
    if (Api_names[permission - 1].empty()) return;

    const std::string escReason = EscapeString(reason);
    if (escReason.empty()) return;

    Applications << "\"" << Api_names[permission - 1] << "\":{"
            << R"("desc":")" << escReason << "\"},";
}

void ApplicationInfo::AddMultiplePermissions(const std::vector<int> &permissions,
                                             const std::string &reason) {
    for (const int perm: permissions) {
        AddPermissionRequest(perm, reason);
    }
}

void ApplicationInfo::AddAllPermissions(const std::string &reason) {
    for (int i = 1; i <= _cnt_Apis; ++i) {
        AddPermissionRequest(i, reason);
    }
}

const char *ApplicationInfo::GetData() const {
    std::ostringstream s;
    s << "{";
    s << R"("sdkv":")" << SDK_VERSION << "\",";
    s << R"("appname":")" << _currentAppName << "\",";

    // 添加信息字段
    for (size_t i = 0; i < _infos.size(); ++i) {
        s << "\"" << _args[i] << "\":\"" << _infos[i] << "\",";
    }

    // 添加地址字段
    for (size_t i = _infos.size(); i < _args.size(); ++i) {
        s << "\"" << _args[i] << "\":" << _addres[i - _infos.size()] << ",";
    }

    // 处理权限数据
    std::string apps = Applications.str();
    if (!apps.empty() && apps.back() == ',') {
        apps.pop_back();
    }

    s << "\"data\":{"
            << "\"needapilist\":{" << apps << "}"
            << "}}";

    return s.str().data();
}
